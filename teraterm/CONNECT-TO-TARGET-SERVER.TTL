;========================================================
; Macro connect MU & BI (single session, countdown)
; Encoding: UTF-8 (no BOM)
;========================================================
timeout = 3

;--- Thông tin chung ---
HOSTIP_DEV     = 'ec2-52-194-17-213.ap-northeast-1.compute.amazonaws.com'
HOSTIP_PRD     = 'ec2-18-176-19-35.ap-northeast-1.compute.amazonaws.com'
USERNAME       = 'ec2-user'

; Thời gian tối đa phiên (giây) - 3 giờ = 10800
MAX_SESSION_SECONDS = 10800
; Khoảng kiểm tra kết nối và cập nhật tiêu đề (giây)
CHECK_INTERVAL_SECONDS = 5

;--------------------------
; Khai báo mảng lựa chọn
;--------------------------
strdim subs 5
subs[0] = 'MU'
subs[1] = 'BI'
subs[2] = 'CM'
subs[3] = 'OR'
subs[4] = 'SJ'

strdim envs 2
envs[0] = 'DEV'
envs[1] = 'PROD'

strdim mail_opts 2
mail_opts[0] = 'NO'
mail_opts[1] = 'YES'

strdim servers 6
servers[0] = 'STAGING'
servers[1] = 'DEV MU01'
servers[2] = 'DEV MU02'
servers[3] = 'DEV MU03'
servers[4] = 'DEV MU04'
servers[5] = 'DEV MU05'

; Biến trạng thái
sub_sel    = -1
env_sel    = -1
mail_sel   = 0
server_sel = -1
STATE_AVAILABLE = 0
connected = 0
TITLE_BASE = ''

;--------------------------
; Đường dẫn file
;--------------------------
getdir mydir
getenv 'TEMP' TMPDIR
if TMPDIR = '' then
    TMPDIR = mydir
endif

LOCK_FILE = TMPDIR
strconcat LOCK_FILE '\CONNECT-TO-TARGET-SERVER.lock'

STATE_FILE = TMPDIR
strconcat STATE_FILE '\CONNECT-TO-TARGET-SERVER.last'

;--------------------------
; Đóng mọi phiên Tera Term đang mở để đảm bảo chỉ 1 macro chạy
;--------------------------
exec 'taskkill /F /IM ttermpro.exe /T'
; Bỏ qua lỗi nếu không có tiến trình nào

; Xóa lock cũ (nếu treo)
fileopen lockh LOCK_FILE 0
if result = 0 then
    fileclose lockh
    filedelete LOCK_FILE
endif

; Tạo lock mới
fileopen lockh LOCK_FILE 1
if result <> 0 then
    messagebox 'Không tạo được lock file. Thoát.' 'Error'
    goto cleanup_no_conn
endif
fileclose lockh

;--------------------------
; Đọc lựa chọn gần nhất nếu có
;--------------------------
STATE_AVAILABLE = 1
fileopen stateh STATE_FILE 0
if result <> 0 then
    STATE_AVAILABLE = 0
else
    filereadln stateh line
    if result <> 0 then STATE_AVAILABLE = 0 endif
    if STATE_AVAILABLE = 1 then str2int last_sub line endif

    filereadln stateh line
    if result <> 0 then STATE_AVAILABLE = 0 endif
    if STATE_AVAILABLE = 1 then str2int last_env line endif

    filereadln stateh line
    if result <> 0 then STATE_AVAILABLE = 0 endif
    if STATE_AVAILABLE = 1 then str2int last_mail line endif

    filereadln stateh line
    if result <> 0 then STATE_AVAILABLE = 0 endif
    if STATE_AVAILABLE = 1 then str2int last_server line endif

    fileclose stateh
endif

if STATE_AVAILABLE = 1 then
    if last_sub < 0 then STATE_AVAILABLE = 0 endif
    if last_sub > 1 then STATE_AVAILABLE = 0 endif ; chỉ MU/BI
    if last_env < 0 then STATE_AVAILABLE = 0 endif
    if last_env > 1 then STATE_AVAILABLE = 0 endif
    if last_mail < 0 then STATE_AVAILABLE = 0 endif
    if last_mail > 1 then STATE_AVAILABLE = 0 endif
    if last_mail = 1 then
        if last_server < 0 then STATE_AVAILABLE = 0 endif
        if last_server > 5 then STATE_AVAILABLE = 0 endif
    endif
endif

if STATE_AVAILABLE = 1 then
    server_label = 'N/A'
    if last_mail = 1 then
        server_label = servers[last_server]
    endif
    sprintf2 last_msg 'Dùng lại cấu hình lần trước? %s / %s / Mail: %s / DB: %s' subs[last_sub] envs[last_env] mail_opts[last_mail] server_label
    yesnobox last_msg 'Dùng cấu hình trước?'
    if result = 1 then
        sub_sel = last_sub
        env_sel = last_env
        mail_sel = last_mail
        server_sel = last_server
        goto selections_done
    endif
endif

;--------------------------
; 1) Chọn Subsystem (giữ nguyên danh sách)
;--------------------------
listbox 'Choose Subsystem' 'Subsystem' subs
if result = -1 then
    messagebox 'Đã hủy.' 'Alert'
    goto cleanup_no_conn
endif
if result > 1 then
    messagebox 'Hiện chỉ hỗ trợ MU/BI.' 'Alert'
    goto cleanup_no_conn
endif
sub_sel = result

;--------------------------
; 2) Chọn Environment (DEV/PROD)
;--------------------------
listbox 'Choose Environment' 'Environment' envs
if result = -1 then
    messagebox 'Đã hủy.' 'Alert'
    goto cleanup_no_conn
endif
env_sel = result

;--------------------------
; 3) Show Mail (chỉ DEV/MU)
;--------------------------
mail_sel = 0 ; mặc định NO
if sub_sel = 0 then
    if env_sel = 0 then
        listbox 'Want to show Mail Info ?' 'Server' mail_opts
        if result = -1 then
            messagebox 'Đã hủy.' 'Alert'
            goto cleanup_no_conn
        endif
        mail_sel = result
    endif
endif

;--------------------------
; 4) Choose DB Server (nếu mail_sel = YES)
;--------------------------
server_sel = -1
if mail_sel = 1 then
    listbox 'Choose DB Server' 'Server' servers
    if result = -1 then
        messagebox 'Đã hủy.' 'Alert'
        goto cleanup_no_conn
    endif
    server_sel = result
endif

:selections_done

;--------------------------
; Lưu lựa chọn lần này
;--------------------------
fileopen stateh STATE_FILE 1
if result = 0 then
    filewriteln stateh sub_sel
    filewriteln stateh env_sel
    filewriteln stateh mail_sel
    filewriteln stateh server_sel
    fileclose stateh
endif

;--------------------------
; 5) Gán KEY_FILE & HOST (Bastion)
;--------------------------
if env_sel = 0 then
    strconcat KEY_FILE mydir
    strconcat KEY_FILE '\DEV-CLASS-BASTION-KEY.pem'
    HOSTIP = HOSTIP_DEV
else
    strconcat KEY_FILE mydir
    strconcat KEY_FILE '\PRD-CLASS-BASTION-KEY.pem'
    HOSTIP = HOSTIP_PRD
endif

strconcat INI_FILE mydir
strconcat INI_FILE '\TERATERM.INI'

;--------------------------
; 6) Tạo lệnh kết nối SSH tới Bastion (publickey)
;--------------------------
sprintf2 COMMAND '%s:22 /ssh /auth=publickey /user=%s /keyfile=%s /F=%s' HOSTIP USERNAME KEY_FILE INI_FILE

;--------------------------
; 7) Hiện Alert và kết nối Bastion
;--------------------------
sprintf2 STATUS 'Connecting to %s - %s' subs[sub_sel] envs[env_sel]
statusbox STATUS 'Alert'

connect COMMAND
if result <> 2 then
    closesbox
    ERRMSG = 'SSH Connection Failed.'
    messagebox ERRMSG 'Error'
    goto cleanup_no_conn
endif

connected = 1
closesbox

;--------------------------
; 8) Nếu cần, chạy getmail.bat để mở mail info
;--------------------------
if env_sel = 0 then
    if sub_sel = 0 then
        if mail_sel = 1 then
            ; Chuyển server_sel thành chuỗi
            sprintf2 ser '%d' server_sel

            ; Tạo đường dẫn đến batch
            BATCH_PATH_STR = mydir
            strconcat BATCH_PATH_STR '\getmail.bat '
            strconcat BATCH_PATH_STR ser

            ; Thực thi batch
            exec BATCH_PATH_STR

            if result <> 0 then
                messagebox 'Không thể chạy batch getmail!' 'Error'
                goto cleanup
            endif
        endif
    endif
endif

;--------------------------
; 9) Theo dõi kết nối và tự đóng khi ngắt hoặc hết 3 giờ
;    Đồng hồ đếm ngược hiển thị trên tiêu đề Tera Term
;--------------------------
remaining = MAX_SESSION_SECONDS
sprintf2 TITLE_BASE '%s - %s' subs[sub_sel] envs[env_sel]
settitle TITLE_BASE

:watch_session

; cập nhật tiêu đề với đếm ngược
minutes = remaining / 60
seconds = remaining - (minutes * 60)
if seconds < 10 then
    sprintf2 TITLE '%s | còn %d:0%d' TITLE_BASE minutes seconds
else
    sprintf2 TITLE '%s | còn %d:%d' TITLE_BASE minutes seconds
endif
settitle TITLE

testlink
if result = 0 then
    messagebox 'Mất kết nối từ server. Đóng tất cả cửa sổ macro.' 'Thông báo'
    goto cleanup
endif

if remaining <= 0 then
    messagebox 'Đã hết thời gian phiên (3 giờ). Đang đóng kết nối.' 'Thông báo'
    goto cleanup
endif

pause CHECK_INTERVAL_SECONDS
remaining = remaining - CHECK_INTERVAL_SECONDS
goto watch_session

:cleanup
if connected = 1 then
    closett
endif
filedelete LOCK_FILE
end

:cleanup_no_conn
filedelete LOCK_FILE
end