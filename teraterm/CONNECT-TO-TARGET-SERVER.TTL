;========================================================
; Macro ket noi MU & BI (1 phien, hien thi thoi gian)
; Encoding: ASCII (khong dau)
;========================================================
timeout = 3

;--- Thong tin chung ---
HOSTIP_DEV     = 'ec2-52-194-17-213.ap-northeast-1.compute.amazonaws.com'
HOSTIP_PRD     = 'ec2-18-176-19-35.ap-northeast-1.compute.amazonaws.com'
USERNAME       = 'ec2-user'

; Thoi gian toi da (giay) - 3 gio = 10800
MAX_SESSION_SECONDS = 10800
; Chu ky kiem tra link / cap nhat tieu de (giay)
CHECK_INTERVAL_SECONDS = 5

;--------------------------
; Lua chon
;--------------------------
strdim subs 5
subs[0] = 'MU'
subs[1] = 'BI'
subs[2] = 'CM'
subs[3] = 'OR'
subs[4] = 'SJ'

strdim envs 2
envs[0] = 'DEV'
envs[1] = 'PROD'

strdim mail_opts 2
mail_opts[0] = 'NO'
mail_opts[1] = 'YES'

strdim servers 6
servers[0] = 'STAGING'
servers[1] = 'DEV MU01'
servers[2] = 'DEV MU02'
servers[3] = 'DEV MU03'
servers[4] = 'DEV MU04'
servers[5] = 'DEV MU05'

; Bien trang thai
sub_sel    = -1
env_sel    = -1
mail_sel   = 0
server_sel = -1
STATE_AVAILABLE = 0
connected = 0
TITLE_BASE = ''

;--------------------------
; Duong dan
;--------------------------
getdir mydir
getenv 'TEMP' TMPDIR
strlen TMPDIR
if result = 0 then
    TMPDIR = mydir
endif

LOCK_FILE = TMPDIR
strconcat LOCK_FILE '\CONNECT-TO-TARGET-SERVER.lock'

STATE_FILE = TMPDIR
strconcat STATE_FILE '\CONNECT-TO-TARGET-SERVER.last'

;--------------------------
; Dam bao chi mot phien: tat Tera Term cu
;--------------------------
exec 'taskkill /F /IM ttermpro.exe /T'
; ignore errors

; Remove stale lock if any
fileopen lockh LOCK_FILE 0
if result = 0 then
    fileclose lockh
    filedelete LOCK_FILE
endif

; Create lock
fileopen lockh LOCK_FILE 1
if result <> 0 then
    messagebox 'Khong tao duoc lock file. Thoat.' 'Error'
    goto cleanup_no_conn
endif
fileclose lockh

;--------------------------
; Doc cau hinh lan truoc neu co
;--------------------------
STATE_AVAILABLE = 1
fileopen stateh STATE_FILE 0
if result <> 0 then
    STATE_AVAILABLE = 0
else
    filereadln stateh line
    if result <> 0 then
        STATE_AVAILABLE = 0
    endif
    if STATE_AVAILABLE = 1 then
        str2int last_sub line
    endif

    filereadln stateh line
    if result <> 0 then
        STATE_AVAILABLE = 0
    endif
    if STATE_AVAILABLE = 1 then
        str2int last_env line
    endif

    filereadln stateh line
    if result <> 0 then
        STATE_AVAILABLE = 0
    endif
    if STATE_AVAILABLE = 1 then
        str2int last_mail line
    endif

    filereadln stateh line
    if result <> 0 then
        STATE_AVAILABLE = 0
    endif
    if STATE_AVAILABLE = 1 then
        str2int last_server line
    endif

    fileclose stateh
endif

if STATE_AVAILABLE = 1 then
    if last_sub < 0 then
        STATE_AVAILABLE = 0
    endif
    if last_sub > 1 then
        STATE_AVAILABLE = 0
    endif ; chỉ MU/BI
    if last_env < 0 then
        STATE_AVAILABLE = 0
    endif
    if last_env > 1 then
        STATE_AVAILABLE = 0
    endif
    if last_mail < 0 then
        STATE_AVAILABLE = 0
    endif
    if last_mail > 1 then
        STATE_AVAILABLE = 0
    endif
    if last_mail = 1 then
        if last_server < 0 then
            STATE_AVAILABLE = 0
        endif
        if last_server > 5 then
            STATE_AVAILABLE = 0
        endif
    endif
endif

if STATE_AVAILABLE = 1 then
    server_label = 'N/A'
    if last_mail = 1 then
        server_label = servers[last_server]
    endif
    sprintf2 last_msg 'Dùng lại cấu hình lần trước? %s / %s / Mail: %s / DB: %s' subs[last_sub] envs[last_env] mail_opts[last_mail] server_label
    yesnobox last_msg 'Dùng cấu hình trước?'
    if result = 1 then
        sub_sel = last_sub
        env_sel = last_env
        mail_sel = last_mail
        server_sel = last_server
        goto selections_done
    endif
endif

;--------------------------
; 1) Chon Subsystem
;--------------------------
listbox 'Chon Subsystem' 'Subsystem' subs
if result = -1 then
    messagebox 'Da huy.' 'Alert'
    goto cleanup_no_conn
endif
if result > 1 then
    messagebox 'Chi ho tro MU/BI.' 'Alert'
    goto cleanup_no_conn
endif
sub_sel = result

;--------------------------
; 2) Chon Environment (DEV/PROD)
;--------------------------
listbox 'Chon Environment' 'Environment' envs
if result = -1 then
    messagebox 'Da huy.' 'Alert'
    goto cleanup_no_conn
endif
env_sel = result

;--------------------------
; 3) Hien thi Mail (chi DEV/MU)
;--------------------------
mail_sel = 0 ; default NO
if sub_sel = 0 then
    if env_sel = 0 then
        listbox 'Xem thong tin mail?' 'Server' mail_opts
        if result = -1 then
            messagebox 'Da huy.' 'Alert'
            goto cleanup_no_conn
        endif
        mail_sel = result
    endif
endif

;--------------------------
; 4) Chon DB Server (neu mail_sel = YES)
;--------------------------
server_sel = -1
if mail_sel = 1 then
    listbox 'Chon DB Server' 'Server' servers
    if result = -1 then
        messagebox 'Da huy.' 'Alert'
        goto cleanup_no_conn
    endif
    server_sel = result
endif

:selections_done

;--------------------------
; Luu cau hinh hien tai
;--------------------------
fileopen stateh STATE_FILE 1
if result = 0 then
    filewriteln stateh sub_sel
    filewriteln stateh env_sel
    filewriteln stateh mail_sel
    filewriteln stateh server_sel
    fileclose stateh
endif

;--------------------------
; 5) Gan KEY_FILE & HOST (Bastion)
;--------------------------
if env_sel = 0 then
    strconcat KEY_FILE mydir
    strconcat KEY_FILE '\DEV-CLASS-BASTION-KEY.pem'
    HOSTIP = HOSTIP_DEV
else
    strconcat KEY_FILE mydir
    strconcat KEY_FILE '\PRD-CLASS-BASTION-KEY.pem'
    HOSTIP = HOSTIP_PRD
endif

strconcat INI_FILE mydir
strconcat INI_FILE '\TERATERM.INI'

;--------------------------
; 6) Tao lenh SSH toi Bastion (publickey)
;--------------------------
sprintf2 COMMAND '%s:22 /ssh /auth=publickey /user=%s /keyfile=%s /F=%s' HOSTIP USERNAME KEY_FILE INI_FILE

;--------------------------
; 7) Hien Alert va ket noi Bastion
;--------------------------
sprintf2 STATUS 'Dang ket noi %s - %s' subs[sub_sel] envs[env_sel]
statusbox STATUS 'Alert'

connect COMMAND
if result <> 2 then
    closesbox
    ERRMSG = 'SSH ket noi that bai.'
    messagebox ERRMSG 'Error'
    goto cleanup_no_conn
endif

connected = 1
closesbox

;--------------------------
; 8) Chay getmail.bat neu can
;--------------------------
if env_sel = 0 then
    if sub_sel = 0 then
        if mail_sel = 1 then
            ; server_sel to string
            sprintf2 ser '%d' server_sel
            ; batch path with quotes
            sprintf2 BATCH_PATH_STR '"%s\getmail.bat" %s' mydir ser
            exec BATCH_PATH_STR
            if result <> 0 then
                messagebox 'Khong chay duoc getmail.bat' 'Error'
                goto cleanup
            endif
        endif
    endif
endif

;--------------------------
; 9) Theo doi ket noi va tu dong dong
;    Tieu de: subsystem / environment / thoi gian da ket noi (MM:SS)
;--------------------------
remaining = MAX_SESSION_SECONDS
sprintf2 TITLE_BASE '%s - %s' subs[sub_sel] envs[env_sel]

; chi dat tieu de khi da link
testlink
if result = 0 then
    goto cleanup
endif

settitle TITLE_BASE

:watch_session

; kiem tra link truoc khi xu ly
testlink
if result = 0 then
    goto cleanup
endif

; cap nhat tieu de voi thoi gian con lai (phut)
minutes = remaining / 60
sprintf2 TITLE '%s | %d min' TITLE_BASE minutes
settitle TITLE

if remaining <= 0 then
    goto cleanup
endif

pause CHECK_INTERVAL_SECONDS
remaining = remaining - CHECK_INTERVAL_SECONDS
goto watch_session

:cleanup
if connected = 1 then
    testlink
    if result <> 0 then
        closett
    endif
endif
filedelete LOCK_FILE
end

:cleanup_no_conn
filedelete LOCK_FILE
end
